<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../partials/head', { title: currentFolder ? currentFolder.name : 'My Drive' }) %>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <h2>üìÅ Storage Drive</h2>
            </div>
            <div class="nav-user">
                <span class="user-greeting">Welcome, <strong><%= user.username %></strong></span>
                <form action="/auth/logout" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-secondary btn-sm">Log Out</button>
                </form>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="drive-content">
            <!-- Breadcrumb -->
            <nav class="breadcrumb">
                <% breadcrumbs.forEach((crumb, index) => { %>
                    <% if (index > 0) { %>
                        <span class="separator">/</span>
                    <% } %>
                    
                    <% if (index === breadcrumbs.length - 1) { %>
                        <span class="current"><%= crumb.name %></span>
                    <% } else { %>
                        <a href="<%= crumb.path %>" class="breadcrumb-link"><%= crumb.name %></a>
                    <% } %>
                <% }); %>
            </nav>

            <!-- Page Header -->
            <div class="page-header">
                <h1><%= currentFolder ? currentFolder.name : 'My Drive' %></h1>
            </div>
            
            <!-- Messages -->
            <%- include('../partials/_messages') %>
            
            <!-- Actions -->
            <div class="minimal-actions">
                <!-- Create Folder -->
                <form action="/mydrive/folders/create" method="POST" class="inline-form">
                    <% if (currentFolder) { %>
                        <input type="hidden" name="parentId" value="<%= currentFolder.id %>" />
                    <% } %>
                    <input 
                        type="text" 
                        name="folderName" 
                        placeholder="üìÅ New folder..." 
                        required 
                        maxlength="50"
                        class="inline-input"
                    />
                    <button type="submit" class="btn btn-sm btn-primary">Create</button>
                </form>

                <!-- Upload File -->
                <form action="/mydrive/upload" method="POST" enctype="multipart/form-data" class="inline-form">
                    <% if (currentFolder) { %>
                        <input type="hidden" name="folderId" value="<%= currentFolder.id %>" />
                    <% } %>
                    <input 
                        type="file" 
                        name="file" 
                        required 
                        class="file-input"
                        id="fileInput"
                    />
                    <label for="fileInput" class="inline-file-label">üì§ Choose file</label>
                    <button type="submit" class="btn btn-sm btn-primary">Upload</button>
                </form>
            </div>

            <!-- Folders Grid -->
            <% if (folders && folders.length > 0) { %>
                <div class="content-section">
                    <h2 class="section-title">üìÅ Folders (<%= folders.length %>)</h2>
                    <div class="folders-grid">
                        <% folders.forEach(folder => { %>
                            <div class="folder-card">
                                <a href="/mydrive/folders/<%= folder.id %>" class="folder-link">
                                    <div class="folder-icon-large">üìÅ</div>
                                    <div class="folder-name"><%= folder.name %></div>
                                    <div class="folder-meta"><%= folder._count.files %> files</div>
                                </a>
                                <div class="folder-actions">
                                    <form action="/mydrive/folders/<%= folder.id %>/delete" method="POST">
                                        <button 
                                            type="submit" 
                                            class="btn btn-danger btn-sm" 
                                            onclick="return confirm('Delete <%= folder.name %>? This will delete all contents.')">
                                            üóëÔ∏è Delete
                                        </button>
                                    </form>
                                </div>
                            </div>
                        <% }); %>
                    </div>
                </div>
            <% } %>

            <!-- Files Table -->
            <% if (files && files.length > 0) { %>
                <div class="content-section">
                    <h2 class="section-title">üìÑ Files (<%= files.length %>)</h2>
                    <div class="table-responsive">
                        <table class="files-table">
                            <thead>
                                <tr>
                                    <th class="col-icon"></th>
                                    <th class="col-name">Name</th>
                                    <th class="col-size">Size</th>
                                    <th class="col-date">Uploaded</th>
                                    <th class="col-actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% files.forEach(file => { %>
                                    <tr class="file-row">
                                        <td class="file-icon">
                                            <% if (file.mimeType.startsWith('image/')) { %>
                                                üñºÔ∏è
                                            <% } else if (file.mimeType === 'application/pdf') { %>
                                                üìÑ
                                            <% } else if (file.mimeType.includes('text')) { %>
                                                üìù
                                            <% } else if (file.mimeType.includes('word')) { %>
                                                üìò
                                            <% } else { %>
                                                üìé
                                            <% } %>
                                        </td>
                                        <td class="file-name"><%= file.name %></td>
                                        <td class="file-size">
                                            <% if (file.size < 1024) { %>
                                                <%= file.size %> B
                                            <% } else if (file.size < 1024 * 1024) { %>
                                                <%= (file.size / 1024).toFixed(1) %> KB
                                            <% } else { %>
                                                <%= (file.size / (1024 * 1024)).toFixed(1) %> MB
                                            <% } %>
                                        </td>
                                        <td class="file-date">
                                            <%= new Date(file.createdAt).toLocaleDateString('en-US', { 
                                                year: 'numeric', 
                                                month: 'short', 
                                                day: 'numeric' 
                                            }) %>
                                        </td>
                                        <td class="file-actions">
                                            <a href="/mydrive/files/<%= file.id %>/download" class="btn btn-secondary btn-sm">
                                                ‚¨áÔ∏è Download
                                            </a>
                                            <form action="/mydrive/files/<%= file.id %>/delete" method="POST">
                                                <button 
                                                    type="submit" 
                                                    class="btn btn-danger btn-sm" 
                                                    onclick="return confirm('Delete <%= file.name %>?')">
                                                    üóëÔ∏è Delete
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                </div>
            <% } %>

            <!-- Empty State -->
            <% if ((!folders || folders.length === 0) && (!files || files.length === 0)) { %>
                <div class="empty-state">
                    <div class="empty-icon">üìÇ</div>
                    <h3>This location is empty</h3>
                    <p class="text-muted">Create a folder or upload a file to get started</p>
                </div>
            <% } %>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('fileInput');
            const fileLabel = document.querySelector('.inline-file-label');
            
            if (fileInput && fileLabel) {
                fileInput.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        fileLabel.textContent = e.target.files[0].name;
                    }
                });
            }
        });
    </script>
</body>
</html>